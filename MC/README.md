# O2DPG - Monte Carlo Simulation

Withing this directory structure are located the scripts and configuration to run Monte Carlo simulations of the ALICE experiment within the O2 project.

## Adding QC Tasks to the simulation script

Below are the steps to integrate a new QC Task to the `o2dpg_sim_workflow.py` script.

1. Build O2, QualityControl and O2DPG with with `o2` defaults:
```
aliBuild build O2 QualityControl O2DPG --defaults o2 -j <jobs>
```

2. Make sure that the setup works by loading the environment and running the example script.
It runs a series of tasks, which are usually DPL workflows that depend on each other and write/read processing results in form of ROOT files.
It will simulate 3 TimeFrames, reconstruct them and run any QC.
Corresponding files will be created in the current directory, QC objects will be also uploaded to QCDB. 
```
alienv enter O2/latest QualityControl/latest O2DPG/latest
cd MC/run/examples
./O2DPG_pp_minbias_multiple_tf_qc.sh
```
If the script does not succeed, contact the repository maintainers.
Sometimes an intermittent issue might appear, then it might be worth executing the script again - it will pick up from the latest failed task.

3. Prepare a QC config file of your Task.
Please make sure to put the following default parameters in the Activity section:
```
     "Activity": {
       ...
       "provenance": "qc_mc",
       "passName": "passMC",
       "periodName": "SimChallenge"
     },

```
With the future developments, they will be overwritten with production-specific values.
Also, since the processing time is not critical, one can avoid using data sampling in most cases and use "direct" data sources (see QC doc)

Put the file to MC/config/QC/json directory or make sure it is installed in the QC package.

4. Find the big loop over simulated TimeFrames and the QC section within.
Add your QC following the example below.
See the explanation of particular lines for more information.
```
for tf in range(1, NTIMEFRAMES + 1):
  ...
  if includeQC:
    ...
    ### Primary vertex
    # Defines what step should run before this task. In this case vertexing QC needs Primary Vertex Finder task, which was defined earlier in the script.
    vertexQCneeds = [PVFINDERtask['name']]
    # Defines the Task name and its parameters. The name should be unique per each TimeFrame. Working directory, labels and computing resources requirements are also defined.
    vertexQCtask = createTask(name='vertexQC_local'+str(tf), needs=vertexQCneeds, tf=tf, cwd=timeframeworkdir, lab=["QC"], cpu=1, mem='2000')
    # Defines the command to run. Usually it is a file reader and o2-qc with --local-batch parameter, which will make QC Tasks store the results in a file and merge with any existing objects.
    vertexQCtask['cmd'] = 'o2-primary-vertex-reader-workflow | o2-qc --config json://${O2DPG_ROOT}/MC/config/QC/json/vertexing-qc-direct-mc.json --local-batch ../' + qcdir + '/vertexQC.root ' + getDPL_global_options()
    # Prevents this task from being run for multiple TimeFrames at the same time, thus trying to modify the same file.
    vertexQCtask['semaphore'] = 'vertexQC'
    # Adds the task to the list of tasks
    workflow['stages'].append(vertexQCtask)
```
The lines above will make the QC task ran for each simulated and reconstructed timeframe separately.
The intermediate results will be stored and merged in one file in the `QC` directory.

5. Find the other QC section after the big TF loop.

This part makes the later parts of QC (Checks, Aggregators, uploading to QCDB) run after all TimeFrames are processed.
Add your QC following the example below, see the comments for particular lines.

```
if includeQC:
  ...
  ### vertexing
  # Makes the task require that vertexing QC for all TFs is completed first.
  vertexQCneeds = ['vertexQC_local'+str(tf) for tf in range(1, NTIMEFRAMES + 1)]
  # Defines the task name, working directory, labels and computing resources requirements.
  vertexQCtask = createTask(name='vertexQC_finalize', needs=vertexQCneeds, cwd=qcdir, lab=["QC"], cpu=1, mem='2000')
  # Defines the command to run. Use the same QC config file and --remote-batch option pointing to the file that was produced by the "local" QC parts.
  vertexQCtask['cmd'] = 'o2-qc --config json://${O2DPG_ROOT}/MC/config/QC/json/vertexing-qc-direct-mc.json --remote-batch vertexQC.root ' + getDPL_global_options()
  # Adds the task to the task list.
  workflow['stages'].append(vertexQCtask)
```

6. Delete the files generated by the workflow during step 2 and run the `O2DPG_pp_minbias_multiple_tf_qc.sh` script again.
Verify that the QC Task succeeds.
Log are available under task names in their working directories: tf<n> when processing TFs and QC during finalization.
